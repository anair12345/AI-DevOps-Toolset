from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Container CVE Gate", version="1.0.0")


class ImageEvaluationRequest(BaseModel):
    image: str
    max_allowed_severity: str = "medium"


class CVEItem(BaseModel):
    id: str
    severity: str
    package: str
    version: str
    fixed_version: str | None = None


class ImageEvaluationResult(BaseModel):
    image: str
    passed: bool
    max_allowed_severity: str
    cves: list[CVEItem]


_SEVERITY_ORDER = {"low": 0, "medium": 1, "high": 2, "critical": 3}


@app.get("/healthz")
def health():
    return {"status": "ok"}


@app.post("/evaluate-image", response_model=ImageEvaluationResult)
def evaluate_image(req: ImageEvaluationRequest):
    cves = [
        CVEItem(
            id="CVE-2024-0001",
            severity="high",
            package="openssl",
            version="1.1.1",
            fixed_version="1.1.2",
        )
    ]

    threshold = _SEVERITY_ORDER.get(req.max_allowed_severity.lower(), 1)
    worst = max((_SEVERITY_ORDER.get(c.severity.lower(), 0) for c in cves), default=0)
    passed = worst <= threshold

    return ImageEvaluationResult(
        image=req.image,
        passed=passed,
        max_allowed_severity=req.max_allowed_severity,
        cves=cves,
    )
